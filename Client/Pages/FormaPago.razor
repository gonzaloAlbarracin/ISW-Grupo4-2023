@page "/forma-pago"
@inject NavigationManager NavigationManager

<h3>Seleccionar Forma de Pago</h3>

<div>
    <label>Forma de Pago:</label>
    <select @bind="formaDePago">
        <option value="Efectivo">Efectivo</option>
        <option value="Debito">Tarjeta de Débito</option>
        <option value="Credito">Tarjeta de Crédito</option>
    </select>
</div>

@if (formaDePago == "Credito" || formaDePago == "Debito")
{
    <div>
        <label>Número de Tarjeta:</label>
        <input type="number" @bind="numeroTarjeta" />
    </div>

    <div>
        <label>Nombre y apellido del titular:</label>
        <input type="text" @bind="nombreApellido" />
    </div>

    <div>
        <label>Fecha de Vencimiento (mm/aaaa):</label>
        <input type="text" @bind="fechaVencimiento" placeholder="mm/aaaa" @oninput="FormatoFechaVencimiento" />
        @if (mostrarErrorFecha)
        {
            <p class="text-danger">@mensajeErrorFecha</p>
        }
    </div>

    <div>
        <label>CVC:</label>
        <input type="number" @bind="CVC" />
    </div>

}
@if (formaDePago == "Efectivo")
{
    <div>
        <label>Monto con el que va a pagar:</label>
        <input type="number" @bind="montoPagar" />
    </div>
}
<button @onclick="Continuar">Continuar</button>

@code {
    private string formaDePago = "Efectivo";
    private string numeroTarjeta = "";
    private string nombreApellido = "";
    private string fechaVencimiento = "";
    private string CVC = "";
    private int montoPagar = 0;
    private bool mostrarErrorFecha = false;
    private string mensajeErrorFecha = "";

    private void Continuar()
    {
        // Implementa la lógica para continuar según la forma de pago seleccionada.
        if (formaDePago == "Efectivo")
        {
            // Redirigir a una página de confirmación de pago en efectivo.
            NavigationManager.NavigateTo("/confirmacion-efectivo");
        }
        else if (formaDePago == "Debito" || formaDePago == "Credito")
        {
            // Redirigir a una página para ingresar detalles de tarjeta de débito o crédito.
            NavigationManager.NavigateTo("/detalle-tarjeta");
        }
    }


    private void FormatoFechaVencimiento(ChangeEventArgs e)
    {
        string fechaInput = e.Value.ToString();
        fechaVencimiento = FormatoFechaSinDia(fechaInput);

        // Validar la fecha ingresada (puedes personalizar esta lógica según tus requisitos)
        if (fechaInput.Length != 7 || !EsFechaValida(fechaInput))
        {
            mostrarErrorFecha = true;
            mensajeErrorFecha = "La fecha ingresada no es válida. Utiliza el formato mm/aaaa.";
        }
        else
        {
            mostrarErrorFecha = false;
            mensajeErrorFecha = "";
        }
    }

    // Función para verificar si la fecha es válida
    private bool EsFechaValida(string fecha)
    {
        // Comprobar si la longitud de la fecha es correcta (mm/aaaa)
        if (fecha.Length != 7)
        {
            return false;
        }

        // Dividir la fecha en mes y año
        string mesStr = fecha.Substring(0, 2);
        string añoStr = fecha.Substring(3);

        // Intentar convertir los valores a números enteros
        if (!int.TryParse(mesStr, out int mes) || !int.TryParse(añoStr, out int año))
        {
            return false;
        }

        // Verificar si el mes está entre 1 y 12
        if (mes < 1 || mes > 12)
        {
            return false;
        }

        if (año < DateTime.Now.Year)
        {
            return false;
        }
        else
        {
            if (año == DateTime.Now.Year && mes < DateTime.Now.Month)
            {
                return false;
            }
        }

        // Si todas las validaciones pasaron, la fecha se considera válida
        return true;
    }


    // Función para dar formato a la fecha de vencimiento (sin el día)
    private string FormatoFechaSinDia(string fecha)
    {
        // Eliminar caracteres no numéricos
        fecha = new string(fecha.Where(char.IsDigit).ToArray());

        // Aplicar formato "mm/aaaa" sin incluir el día
        if (fecha.Length >= 4)
        {
            fecha = fecha.Substring(0, 2) + "/" + fecha.Substring(2, 4);
        }

        return fecha;
    }
}
